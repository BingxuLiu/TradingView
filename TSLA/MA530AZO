// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © cloudyxmu

//@version=6
strategy("TSLA双均线", overlay=true, pyramiding=5, default_qty_type=strategy.percent_of_equity, default_qty_value=90)
// 计算移动均线
ma5 = ta.sma(close, 5)
ma30 = ta.sma(close, 30)
// 绘制移动均线
plot(ma5, color=color.red, title="Fast")
plot(ma30, color=color.blue, title="Slow")

if ta.crossover(ma5, ma30)
    // 买入信号：清仓AZO和ORLY，全仓买入TSLA
    strategy.close("AZO买入", comment="清仓AZO")
    strategy.close("ORLY买入", comment="清仓ORLY")
    strategy.entry("BUY", strategy.long, qty_percent=100, comment="买入TSLA")
if ta.crossover(ma30, ma5)
    // 卖出信号：清仓TSLA，买入AZO和ORLY各50%
    strategy.close("BUY", comment="卖出TSLA")
    strategy.entry("AZO买入", strategy.long, qty_percent=50, ticker="AZO", comment="AZO买入")
    strategy.entry("ORLY买入", strategy.long, qty_percent=50, ticker="ORLY", comment="ORLY买入")

// 统计平均持仓时间
var float totalHoldBars = 0.0
var int tradeCount = 0
var float avgHoldBars = 0
if strategy.closedtrades > 0
    for i = 0 to strategy.closedtrades - 1
        totalHoldBars += strategy.closedtrades.exit_bar_index(i) - strategy.closedtrades.entry_bar_index(i)
        tradeCount += 1
    avgHoldBars := tradeCount > 0 ? totalHoldBars / tradeCount : 0

// 在图表右上角绘制平均持仓时间
var table statsTable = table.new(position.top_right, 1, 1)
if barstate.islast
    table.cell(statsTable, 0, 0, "平均持仓: " + (str.tostring(avgHoldBars, "#.##")) + " 根K线", text_color=color.white, text_size=size.normal)
